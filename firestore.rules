rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isValidString(value, minLen, maxLen) {
      return value is string && value.size() >= minLen && value.size() <= maxLen;
    }

    function isValidNumber(value, min, max) {
      return value is number && value >= min && value <= max;
    }

    function isValidTimestamp(value) {
      return value is timestamp;
    }

    // User profile rules
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && validateUserProfile(request.resource.data);
      allow update: if isOwner(userId) && validateUserProfile(request.resource.data);
      allow delete: if isOwner(userId);

      function validateUserProfile(data) {
        return data.keys().hasAll(['email']) &&
               isValidString(data.email, 5, 254);
      }

      // User's meals subcollection
      match /meals/{mealId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateMeal(request.resource.data);
        allow update: if isOwner(userId) && validateMeal(request.resource.data);
        allow delete: if isOwner(userId);

        function validateMeal(data) {
          return data.keys().hasAll(['name', 'calories', 'createdAt']) &&
                 isValidString(data.name, 1, 200) &&
                 isValidNumber(data.calories, 0, 10000) &&
                 isValidTimestamp(data.createdAt);
        }
      }

      // User's workouts subcollection
      match /workouts/{workoutId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateWorkout(request.resource.data);
        allow update: if isOwner(userId) && validateWorkout(request.resource.data);
        allow delete: if isOwner(userId);

        function validateWorkout(data) {
          return data.keys().hasAll(['workoutName', 'createdAt']) &&
                 isValidString(data.workoutName, 1, 200) &&
                 isValidTimestamp(data.createdAt);
        }
      }

      // User's measurements subcollection
      match /measurements/{measurementId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateMeasurement(request.resource.data);
        allow update: if isOwner(userId) && validateMeasurement(request.resource.data);
        allow delete: if isOwner(userId);

        function validateMeasurement(data) {
          return data.keys().hasAll(['createdAt']) &&
                 isValidTimestamp(data.createdAt) &&
                 // Validate optional numeric fields if present
                 (data.weight == null || isValidNumber(data.weight, 20, 500)) &&
                 (data.bodyFat == null || isValidNumber(data.bodyFat, 2, 60)) &&
                 (data.muscleMass == null || isValidNumber(data.muscleMass, 10, 200));
        }
      }

      // User's achievements subcollection
      match /achievements/{achievementId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && validateAchievement(request.resource.data);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);

        function validateAchievement(data) {
          return data.keys().hasAll(['name', 'unlockedAt']) &&
                 isValidString(data.name, 1, 200) &&
                 isValidTimestamp(data.unlockedAt);
        }
      }

      // User's workout plans subcollection
      match /workoutPlans/{planId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // User's nutrition goals subcollection
      match /nutritionGoals/{goalId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
